{% extends 'base.html' %}
{% load static %}
{% block customcss %}
<link rel="stylesheet" href="{% static 'main_app/css/acheter.css' %}">
<style>
    .hero-section {
        background: url("{% static 'main_app/acheter/hero-1.png' %}") center/cover no-repeat;
    }
</style>
{% endblock %}

{% block header %}
{% include 'header.html' with acheter="active" %}
{% endblock %}

{% block body %}



<div class="page-container">
    <div class="hero-section">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">Acheter un bien </h1>
                <p class="hero-description">Découvrez notre sélection de propriétés pour concrétiser votre projet
                    immobilier.
                </p>
            </div>
        </div>
    </div>


    <div class="container">
        <div class="search-section">
            <div class="search-form">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                    </svg>
                    <input type="text" placeholder="Rechercher par ville, code postal..." class="search-input"
                        id="recherche" />
                </div>
                <select class="search-select" id="tri_type_de_bien">
                    <option value="">Type de bien</option>
                    {% for typebien in type_de_bien %}
                    <option value="{{typebien.label}}">{{typebien.label}}</option>
                    {% endfor %}
                </select>
                <select class="search-select" id="tri_budget_max">
                    <option value="">Budget max</option>
                    <option value="100000000">100 000 000 Ar</option>
                    <option value="500000000">500 000 000 Ar</option>
                    <option value="1000000000">1 000 000 000 Ar</option>
                    <option value="2500000000">2 500 000 000 Ar</option>
                    <option value="10000000000">10 000 000 000 Ar</option>
                </select>
                <button class="filters-btn"
                    onclick="document.getElementById('advancedFilters').classList.toggle('show');">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" y1="21" x2="4" y2="14"></line>
                        <line x1="4" y1="10" x2="4" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12" y2="3"></line>
                        <line x1="20" y1="21" x2="20" y2="16"></line>
                        <line x1="20" y1="12" x2="20" y2="3"></line>
                        <line x1="1" y1="14" x2="7" y2="14"></line>
                        <line x1="9" y1="8" x2="15" y2="8"></line>
                        <line x1="17" y1="16" x2="23" y2="16"></line>
                    </svg>
                </button>
            </div>

            <div class="advanced-filters" id="advancedFilters">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Surface habitable m<sup>2</sup></label>
                        <div class="range-container">
                            <input type="text" placeholder="Min" class="range-input" id="tri_min_range" min="0" />
                            <span class="range-separator">-</span>
                            <input type="text" placeholder="Max" class="range-input" id="tri_max_range" min="1" />
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Chambres</label>
                        <select class="filter-select" id="tri_chambre">
                            <option value="">Toutes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Salles de bain</label>
                        <select class="filter-select" id="tri_salle_de_bain">
                            <option value="">Toutes</option>

                        </select>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            for (x of find_set(biens, 'chambre')) {
                                let el = document.createElement('option')
                                el.setAttribute("value", x);
                                el.innerText = x;
                                chambre.appendChild(el);
                            }
                            for (x of find_set(biens, 'salle_de_bain')) {
                                let el = document.createElement('option')
                                el.setAttribute("value", x);
                                el.innerText = x;
                                salle_de_bain.appendChild(el);
                            }
                        })
                    </script>
                </div>
            </div>
        </div>

        <div class="results-header">
            <p class="results-count" id="resultat"><span></span> biens trouvés</p>
            <div class="sort-container">
                <span class="sort-label">Trier par:</span>
                <select class="sort-select" id="tri_sort">
                    <option value="1" selected>Prix (croissant)</option>
                    <option value="2">Prix (décroissant)</option>
                </select>
            </div>
        </div>


        <div class="properties-grid" id="propertiesGrid">


        </div>
        <div class="loading" id="loading">
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div class="pagination-container">
            <div class="pagination" id="paginationId">
            </div>
        </div>
    </div>
</div>


<div class="modal-overlay" id="propertyModal">




</div>

<script>

    let bienContainer = document.getElementById("propertiesGrid");

    let biens = {{ biens| safe}};
    let to_use_biens = [...biens];
    let bienId = [];
    let recherche = document.getElementById("recherche");
    let type_de_bien = document.getElementById("tri_type_de_bien");
    let budget_max = document.getElementById("tri_budget_max");
    let min_range = document.getElementById("tri_min_range");
    let max_range = document.getElementById("tri_max_range");
    let chambre = document.getElementById("tri_chambre");
    let salle_de_bain = document.getElementById("tri_salle_de_bain");
    let tri_sort = document.getElementById("tri_sort");
    let resultat = document.querySelector("#resultat span");
    let loading = document.getElementById("loading");
    let wait, wait_render;

    loading.style.display = "none";
    recherche.value = "";
    type_de_bien.value = "";
    budget_max.value = "";
    min_range.value = "";
    max_range.value = "";
    chambre.value = "";
    salle_de_bain.value = "";





    let paginationContainer = document.getElementById("paginationId")
    let currentpage = 1;
    let totalpage;
    function setPage(currentn) {
        paginationContainer.children[currentpage].classList.remove('pagination-active');
        if (currentn == 'next') {
            currentpage = ((currentpage % totalpage) + 1);

        }
        else if (currentn == 'prev') {
            currentpage = ((((currentpage - 1) + totalpage - 1) % totalpage) + 1);
        }
        else {
            currentpage = currentn;
        }
        paginationContainer.children[currentpage].classList.add('pagination-active');
        load_value(to_use_biens, ((currentpage - 1) * 6));
    }
    function render_page(numpage) {
        paginationContainer.innerHTML = `<button class="pagination-btn pagination-prev" onclick="setPage('next')">Précédent</button>`;
        for (i = 1; i <= numpage; i++) {
            paginationContainer.innerHTML += `<button onclick="setPage(${i})" class="pagination-btn ${(i == 1) ? "pagination-active" : ""}">${i}</button>`;
        }
        paginationContainer.innerHTML += `<button class="pagination-btn pagination-next" onclick="setPage('prev')">Suivant</button>`;
    }








    recherche.addEventListener('input', () => {
        render();
    })
    type_de_bien.addEventListener('change', () => {
        render();
    })
    budget_max.addEventListener('change', () => {
        render();
    })
    min_range.addEventListener('input', (e) => {
        if (isNaN(e.data)) {
            min_range.value = min_range.value.slice(0, min_range.value.length - 1);
        }
        else {
            render();
        }
    })
    max_range.addEventListener('input', (e) => {
        if (isNaN(e.data)) {
            max_range.value = max_range.value.slice(0, max_range.value.length - 1);
        }
        else {
            render();
        }
    })
    chambre.addEventListener('change', () => {
        render();
    })
    salle_de_bain.addEventListener('change', () => {
        render();
    })
    tri_sort.addEventListener('change', () => {

        bienContainer.style.display = 'none';
        loading.style.display = '';

        setTimeout(() => {

            bienContainer.style.display = '';
            loading.style.display = 'none';
        }, 600);

        setTimeout(() => {

            to_use_biens.sort((a, b) => {
                if (tri_sort.value == "1") {
                    return ((a.prix) - (b.prix));
                }
                if (tri_sort.value == "2") {
                    return (b.prix) - (a.prix);
                }
            });
            load_value(to_use_biens);
        });

    }, 100)


    function find_set(obj, key) {
        res = []
        for (x of obj) {
            if (!(res.includes(x[key]))) {

                res.push(x[key])


            }
        }
        return res.sort()
    }


    function render() {
        bienContainer.style.display = "none";
        loading.style.display = "";
        clearTimeout(wait);
        clearTimeout(wait_render);
        wait = setTimeout(() => {
            bienContainer.style.display = "";
            loading.style.display = 'none';
        }, 1500);
        wait_render = setTimeout(() => {
            to_use_biens = biens.filter((bien) => {
                if (recherche.value.length && !bien.localisation.toLowerCase().match(`${recherche.value.toLowerCase()}`)) {

                    return false;
                }
                if (type_de_bien.value.length && bien.type_de_bien.label != type_de_bien.value) {

                    return false;
                }
                if (budget_max.value && bien.prix > Number(budget_max.value)) {

                    return false;
                }
                if (min_range.value && bien.prix < min_range.value) {

                    return false;
                }
                if (max_range.value && bien.prix > max_range.value) {

                    return false;
                }
                if (chambre.value && bien.chambre != Number(chambre.value)) {

                    return false;
                }
                if (salle_de_bain.value && bien.salle_de_bain != Number(salle_de_bain.value)) {

                    return false;
                }
                if (bienId.includes(bien.id)) {

                }
                return true;
            })
            resultat.innerText = to_use_biens.length;
            to_use_biens.sort((a, b) => {
                if (tri_sort.value == "1") {
                    return (a.prix) - (b.prix);
                }
                else if (tri_sort.value == "2") {
                    return (b.prix) - (a.prix)
                }
            })
            totalpage = Math.ceil(((to_use_biens.length) / 6));
            render_page(totalpage)
            load_value(to_use_biens);
        }, 700);

    }

    function load_value(objarg, start = 0) {
        bienContainer.innerHTML = "";
        for (let i = 0; i < 6; i++) {
            if (start >= objarg.length) {
                break;
            }
            let obj = objarg[start++];
            if (bienId[obj.id]) {
                bienContainer.appendChild(bienId[obj.id]);
            }
            else {
                let element = document.createElement('div')

                element.innerHTML += `
            <div class="property-card" onclick="openModal(this)" data-id="${obj.id}"
                data-title="${obj.titre}" data-location="${obj.localisation}" data-price="${obj.prix}"
                data-bedrooms="${obj.chambre}" data-bathrooms="${obj.salle_de_bain}" data-area="${obj.surface}" data-type="${obj.type_de_bien.label}"
                data-amenities="${obj.atout}"
                data-images="${obj.image}"
                data-description="${obj.description}"
                data-owner="${obj.notaire.nom} ${obj.notaire.prenom}" data-owner-phone="${obj.notaire.telephone}" data-owner-email="${obj.notaire.email}">
                <div class="property-image">
                    <img src="${obj.image}" alt="${obj.titre}" />
                    <div class="property-badge">${obj.type_de_bien.label}</div>
                </div>
                <div class="property-content">
                    <h3 class="property-title">${obj.titre}</h3>
                    <p class="property-location">${obj.localisation}</p>
                    <div class="property-details">
                        <span class="detail-item">${obj.chambre} chambres</span>
                        <span class="detail-item">${obj.salle_de_bain} salles de bain</span>
                        <span class="detail-item">${obj.surface} m²</span>
                    </div>
                    <div class="property-price">${format(obj.prix)} Ar</div>
                </div>
            </div>
            
            `
                bienId[obj.id] = element.children[0];
                bienContainer.appendChild(element.children[0])
            }

        }
    }
    function format(n) {
        n = n.toString()
        res = ""
        let a = n.length;
        let num = n.length;
        while (--a >= 0) {
            res = n[a] + res

            if (a > 0 && a != num && ((num - a) % 3) == 0) {

                res = " " + res
            }
        }


        return res
    }

    let modalContainer = document.getElementById("propertyModal");
    function openModal(element) {
            modalContainer.innerHTML = `
            <div class="modal-content" >
            <button class="modal-close" aria-label="Fermer" onclick="modalContainer.classList.remove('show')">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>

            <div class="modal-body">
                <div class="modal-gallery">
                    <div class="gallery-main">
                        <img id="modalImage" src="${element.getAttribute('data-images')}" alt="" />

                        <div class="modal-badge" id="modalBadge">${element.getAttribute('data-type')}</div>

                    </div>

                </div>

                <div class="modal-info">
                    <div class="modal-header">
                        <div class="modal-title-wrap">
                            <h2 class="modal-title" id="modalTitle">${element.getAttribute('data-title')}</h2>

                        </div>
                        <div class="modal-price" id="modalPrice">${formatPrice(element.getAttribute('data-price'))}</div>
                        <div class="modal-location" id="modalLocation">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span>${element.getAttribute('data-location')}</span>
                        </div>
                    </div>

                    <div class="modal-details">
                        <div class="detail-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9,22 9,12 15,12 15,22"></polyline>
                            </svg>
                            <span class="bedrooms">${element.getAttribute('data-bedrooms').padStart(2, 0)}</span>
                        </div>
                        <div class="detail-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                            </svg>
                            <span class="bathrooms">${element.getAttribute('data-bathrooms').padStart(2, 0)}</span>
                        </div>
                        <div class="detail-item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                            </svg>
                            <span class="area">${element.getAttribute('data-area').padStart(2, 0)} m<sup>2</sup></span>
                        </div>
                    </div>

                    <div class="modal-amenities">
                        <h3>Atouts</h3>
                        <div class="amenities-list" id="modalAmenities">
                            ${element.getAttribute('data-amenities').split('\n').reduce((prev, curr) => prev + '<span class="amenity-pill">' + curr + '</span>', '')}
                        </div>
                    </div>

                    <div class="modal-description">
                        <h3>Description</h3>
                        <p id="modalDescriptionText">${element.getAttribute('data-description')}</p>
                    </div>

                    <div class="modal-owner">
                        <h3>Propriétaire</h3>
                        <div class="owner-card">
                            <div class="owner-avatar">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <div class="owner-details">
                                <div class="owner-name" id="modalOwnerName">${element.getAttribute('data-owner')}</div>
                                <div class="owner-contact">
                                    <button class="owner-contact-btn" id="ownerCallBtn">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <path
                                                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
                                        </svg>
                                        <span id="modalOwnerPhone">${element.getAttribute('data-owner-phone')}</span>
                                    </button>
                                    <button class="owner-contact-btn" id="ownerEmailBtn">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <path
                                                d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z">
                                            </path>
                                            <polyline points="22,6 12,13 2,6"></polyline>
                                        </svg>
                                        <span id="modalOwnerEmail">${element.getAttribute('data-owner-email')}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
            `;

        modalContainer.classList.add('show');
    }


    function formatPrice(price) {
        let result = "";
        let c;
        let count = 0;
        while (price > 0) {
            count += 1;
            c = price % 10;
            result = c.toString() + result;
            price = parseInt(price / 10);
            if (count % 3 == 0) {
                result = " " + result;
            }
        }
        result += " Ar";
        return result;
    }


    document.addEventListener('DOMContentLoaded', () => {
        render();
        // modalContainer.classList.add('show');
    });



</script>
{% endblock %}